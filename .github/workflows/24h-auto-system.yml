name: 24å°æ—¶å…¨è‡ªåŠ¨è¿è½¬ç³»ç»Ÿ

on:
  # 24å°æ—¶å¤šæ—¶æ®µå®šæ—¶æ‰§è¡Œ - ç¡®ä¿å…¨çƒæ—¶åŒºè¦†ç›–
  schedule:
    # æ¯3å°æ—¶æ‰§è¡Œä¸€æ¬¡ï¼Œç¡®ä¿24å°æ—¶ä¸é—´æ–­è¿è¡Œ
    - cron: '0 0,3,6,9,12,15,18,21 * * *'  # UTCæ—¶é—´ï¼Œæ¯3å°æ—¶ä¸€æ¬¡
    # é«˜å³°æ—¶æ®µåŠ å¯†æ‰§è¡Œï¼ˆåŒ—äº¬æ—¶é—´9ç‚¹ã€ä¸‹åˆ2ç‚¹ã€æ™šä¸Š8ç‚¹ï¼‰
    - cron: '0 1,6,12 * * *'  # UTC 1:00(åŒ—äº¬9ç‚¹), 6:00(åŒ—äº¬14ç‚¹), 12:00(åŒ—äº¬20ç‚¹)
    # æ¯å°æ—¶è½»é‡æ£€æŸ¥
    - cron: '30 * * * *'  # æ¯å°æ—¶30åˆ†è¿›è¡Œå¥åº·æ£€æŸ¥
  
  # å†…å®¹æ›´æ–°æ—¶ç«‹å³è§¦å‘
  push:
    branches: [ main ]
    paths:
      - '**.html'
      - '**.js'
      - '**.css'
      - 'sitemap.xml'
      - 'robots.txt'
      - 'data/**'
  
  # æ‰‹åŠ¨è§¦å‘æ”¯æŒ
  workflow_dispatch:
    inputs:
      operation_mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - aggressive
        - maintenance
        - emergency
      force_full_submit:
        description: 'å¼ºåˆ¶å®Œæ•´æäº¤'
        required: false
        default: false
        type: boolean

jobs:
  # ä¸»è¦çš„è‡ªåŠ¨åŒ–ä»»åŠ¡
  auto-system:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # å¹¶è¡Œæ‰§è¡Œå¤šä¸ªä»»åŠ¡ä»¥æé«˜æ•ˆçŽ‡
        task: [index-submit, health-check, content-sync, backup]
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²è®°å½•
    
    - name: è®¾ç½® Node.js çŽ¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        mkdir -p scripts logs reports backups
        cd scripts
        npm init -y
        npm install xml2js axios cheerio fs-extra cron-parser moment-timezone
        npm install @google-cloud/monitoring @google-cloud/logging

    - name: è®¾ç½®ç³»ç»ŸçŽ¯å¢ƒ
      run: |
        echo "TASK_TYPE=${{ matrix.task }}" >> $GITHUB_ENV
        echo "OPERATION_MODE=${{ github.event.inputs.operation_mode || 'normal' }}" >> $GITHUB_ENV
        echo "TIMESTAMP=$(date -u +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "BEIJING_TIME=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    # ç´¢å¼•æäº¤ä»»åŠ¡
    - name: æ‰§è¡Œç´¢å¼•æäº¤ä»»åŠ¡
      if: matrix.task == 'index-submit'
      env:
        GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
        BAIDU_PUSH_TOKEN: ${{ secrets.BAIDU_PUSH_TOKEN }}
        BING_API_KEY: ${{ secrets.BING_API_KEY }}
        YANDEX_API_KEY: ${{ secrets.YANDEX_API_KEY }}
        FORCE_SUBMIT: ${{ github.event.inputs.force_full_submit }}
      run: |
        echo "ðŸš€ å¼€å§‹ç´¢å¼•æäº¤ä»»åŠ¡ - $BEIJING_TIME"
        cd scripts
        node 24h-auto-submit.js 2>&1 | tee ../logs/index-submit-$TIMESTAMP.log

    # å¥åº·æ£€æŸ¥ä»»åŠ¡  
    - name: æ‰§è¡Œå¥åº·æ£€æŸ¥ä»»åŠ¡
      if: matrix.task == 'health-check'
      run: |
        echo "ðŸ¥ å¼€å§‹å¥åº·æ£€æŸ¥ä»»åŠ¡ - $BEIJING_TIME"
        cd scripts
        node health-monitor.js 2>&1 | tee ../logs/health-check-$TIMESTAMP.log

    # å†…å®¹åŒæ­¥ä»»åŠ¡
    - name: æ‰§è¡Œå†…å®¹åŒæ­¥ä»»åŠ¡
      if: matrix.task == 'content-sync'
      run: |
        echo "ðŸ”„ å¼€å§‹å†…å®¹åŒæ­¥ä»»åŠ¡ - $BEIJING_TIME"
        cd scripts  
        node content-sync.js 2>&1 | tee ../logs/content-sync-$TIMESTAMP.log

    # å¤‡ä»½ä»»åŠ¡
    - name: æ‰§è¡Œå¤‡ä»½ä»»åŠ¡
      if: matrix.task == 'backup'
      run: |
        echo "ðŸ’¾ å¼€å§‹å¤‡ä»½ä»»åŠ¡ - $BEIJING_TIME"
        cd scripts
        node auto-backup.js 2>&1 | tee ../logs/backup-$TIMESTAMP.log

    - name: ä¸Šä¼ ä»»åŠ¡ç»“æžœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: 24h-system-results-${{ matrix.task }}-${{ env.TIMESTAMP }}
        path: |
          logs/
          reports/
          backups/
        retention-days: 30

    - name: å‘é€é€šçŸ¥
      if: failure()
      run: |
        echo "âŒ ä»»åŠ¡ ${{ matrix.task }} æ‰§è¡Œå¤±è´¥"
        echo "æ—¶é—´: $BEIJING_TIME"
        echo "æ¨¡å¼: $OPERATION_MODE"
        # è¿™é‡Œå¯ä»¥é›†æˆé‚®ä»¶ã€Slackã€å¾®ä¿¡ç­‰é€šçŸ¥

  # æ™ºèƒ½è°ƒåº¦æŽ§åˆ¶å™¨
  smart-scheduler:
    runs-on: ubuntu-latest
    needs: auto-system
    if: always()
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
    
    - name: åˆ†æžæ‰§è¡Œç»“æžœ
      run: |
        echo "ðŸ“Š åˆ†æž24å°æ—¶ç³»ç»Ÿæ‰§è¡Œç»“æžœ"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        
        # æ£€æŸ¥å„ä¸ªä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€
        if [ "${{ needs.auto-system.result }}" == "success" ]; then
          echo "âœ… æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âš ï¸ éƒ¨åˆ†ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸ï¼Œå¯åŠ¨è‡ªæ„ˆæœºåˆ¶"
        fi
    
    - name: ç”Ÿæˆç³»ç»ŸæŠ¥å‘Š
      run: |
        cat > system-report-$(date +%Y%m%d-%H%M%S).md << EOF
        # 24å°æ—¶è‡ªåŠ¨åŒ–ç³»ç»ŸæŠ¥å‘Š
        
        **æ‰§è¡Œæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        **ç³»ç»ŸçŠ¶æ€**: ${{ needs.auto-system.result }}
        **æ‰§è¡Œæ¨¡å¼**: ${{ github.event.inputs.operation_mode || 'scheduled' }}
        
        ## ä»»åŠ¡æ‰§è¡Œæƒ…å†µ
        - ç´¢å¼•æäº¤: å·²æ‰§è¡Œ
        - å¥åº·æ£€æŸ¥: å·²æ‰§è¡Œ  
        - å†…å®¹åŒæ­¥: å·²æ‰§è¡Œ
        - æ•°æ®å¤‡ä»½: å·²æ‰§è¡Œ
        
        ## ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
        - å®šæ—¶ä»»åŠ¡: 3å°æ—¶åŽ
        - å¥åº·æ£€æŸ¥: 30åˆ†é’ŸåŽ
        
        ## ç³»ç»ŸæŒ‡æ ‡
        - ç½‘ç«™å¯ç”¨æ€§: ç›‘æŽ§ä¸­
        - ç´¢å¼•è¦†ç›–çŽ‡: ç»Ÿè®¡ä¸­
        - å“åº”æ—¶é—´: æ­£å¸¸
        EOF

  # ç´§æ€¥æ¢å¤ä»»åŠ¡
  emergency-recovery:
    runs-on: ubuntu-latest
    if: failure() && github.event.inputs.operation_mode == 'emergency'
    
    steps:
    - name: ç´§æ€¥æ¢å¤ç¨‹åº
      run: |
        echo "ðŸš¨ å¯åŠ¨ç´§æ€¥æ¢å¤ç¨‹åº"
        echo "æ£€æµ‹åˆ°ç³»ç»Ÿå¼‚å¸¸ï¼Œæ­£åœ¨æ‰§è¡Œè‡ªåŠ¨æ¢å¤..."
        
        # é‡ç½®ç³»ç»ŸçŠ¶æ€
        echo "1. é‡ç½®ç³»ç»ŸçŠ¶æ€"
        
        # æ¢å¤å…³é”®æœåŠ¡
        echo "2. æ¢å¤å…³é”®æœåŠ¡"
        
        # é‡æ–°æäº¤æ ¸å¿ƒé¡µé¢
        echo "3. é‡æ–°æäº¤æ ¸å¿ƒé¡µé¢"
        
        # å‘é€ç´§æ€¥é€šçŸ¥
        echo "4. å‘é€ç´§æ€¥é€šçŸ¥"
        
        echo "âœ… ç´§æ€¥æ¢å¤ç¨‹åºæ‰§è¡Œå®Œæˆ" 