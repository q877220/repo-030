name: 24å°æ—¶å…³é”®è¯æ’åç›‘æ§ç³»ç»Ÿ

on:
  # å…³é”®è¯é‡‡é›† - æ¯å¤©æ‰§è¡Œ2æ¬¡
  schedule:
    - cron: '0 2,14 * * *'  # UTC 2:00(åŒ—äº¬10ç‚¹) å’Œ 14:00(åŒ—äº¬22ç‚¹)
  
  # æ’åç›‘æ§ - æ¯4å°æ—¶æ‰§è¡Œä¸€æ¬¡
  schedule:
    - cron: '30 */4 * * *'  # æ¯4å°æ—¶çš„30åˆ†æ‰§è¡Œ
  
  # æ™ºèƒ½åˆ†æ - æ¯å¤©æ—©ä¸Šæ‰§è¡Œ
  schedule:
    - cron: '0 1 * * *'  # UTC 1:00(åŒ—äº¬9ç‚¹)
  
  # å†…å®¹æ›´æ–°æ—¶è§¦å‘å…³é”®è¯é‡‡é›†
  push:
    branches: [ main ]
    paths:
      - '**.html'
      - 'data/**'
      - 'scripts/keyword-**'
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      task_type:
        description: 'æ‰§è¡Œä»»åŠ¡ç±»å‹'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - collect
        - monitor
        - analyze
      keyword_limit:
        description: 'å…³é”®è¯æ•°é‡é™åˆ¶'
        required: false
        default: '200'
        type: string
      force_collection:
        description: 'å¼ºåˆ¶é‡æ–°é‡‡é›†'
        required: false
        default: false
        type: boolean

jobs:
  # å…³é”®è¯é‡‡é›†ä»»åŠ¡
  keyword-collection:
    runs-on: ubuntu-latest
    if: contains(github.event.schedule, '2,14') || github.event.inputs.task_type == 'collect' || github.event.inputs.task_type == 'full' || github.event.inputs.force_collection == 'true'
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd scripts
        npm init -y
        npm install fs-extra moment-timezone crypto https xml2js cheerio
    
    - name: æ‰§è¡Œå…³é”®è¯é‡‡é›†
      run: |
        echo "ğŸš€ å¼€å§‹å…³é”®è¯é‡‡é›†ä»»åŠ¡"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        cd scripts
        node keyword-collector.js 2>&1 | tee ../logs/keyword-collection-$(date +%Y%m%d-%H%M%S).log
    
    - name: æäº¤é‡‡é›†ç»“æœ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/keywords/ logs/
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„å…³é”®è¯æ•°æ®"
        else
          git commit -m "ğŸ” è‡ªåŠ¨å…³é”®è¯é‡‡é›†: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: ä¸Šä¼ é‡‡é›†æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: keyword-collection-report-${{ github.run_id }}
        path: |
          logs/keyword-collection-*.log
          reports/keyword-collection-*.json
        retention-days: 30

  # æ’åç›‘æ§ä»»åŠ¡
  ranking-monitor:
    runs-on: ubuntu-latest
    needs: keyword-collection
    if: always() && (contains(github.event.schedule, '*/4') || github.event.inputs.task_type == 'monitor' || github.event.inputs.task_type == 'full')
    
    strategy:
      matrix:
        batch: [1, 2, 3, 4]  # åˆ†æ‰¹æ‰§è¡Œé¿å…APIé™åˆ¶
      fail-fast: false
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: æ‹‰å–æœ€æ–°æ•°æ®
      run: |
        git pull origin main || true
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd scripts
        npm init -y
        npm install fs-extra moment-timezone cheerio https
    
    - name: è®¾ç½®æ‰¹æ¬¡ç¯å¢ƒ
      run: |
        echo "BATCH_NUMBER=${{ matrix.batch }}" >> $GITHUB_ENV
        echo "TOTAL_BATCHES=4" >> $GITHUB_ENV
        echo "KEYWORD_LIMIT=${{ github.event.inputs.keyword_limit || '200' }}" >> $GITHUB_ENV
    
    - name: æ‰§è¡Œæ’åç›‘æ§ (æ‰¹æ¬¡ ${{ matrix.batch }})
      run: |
        echo "ğŸ“Š å¼€å§‹æ’åç›‘æ§ä»»åŠ¡ - æ‰¹æ¬¡ ${{ matrix.batch }}/4"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        cd scripts
        node ranking-monitor.js 2>&1 | tee ../logs/ranking-monitor-batch${{ matrix.batch }}-$(date +%Y%m%d-%H%M%S).log
      env:
        SEARCH_DELAY: 5000  # å¢åŠ è¯·æ±‚é—´éš”é¿å…è¢«é™åˆ¶
        MAX_PAGES: 3        # é™åˆ¶æœç´¢é¡µæ•°
        BATCH_SIZE: 5       # å°æ‰¹é‡å¤„ç†
    
    - name: ä¸Šä¼ ç›‘æ§ç»“æœ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ranking-monitor-batch${{ matrix.batch }}-${{ github.run_id }}
        path: |
          logs/ranking-monitor-*.log
          data/rankings/
        retention-days: 30

  # åˆå¹¶æ’åæ•°æ®
  merge-ranking-data:
    runs-on: ubuntu-latest
    needs: ranking-monitor
    if: always()
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
    
    - name: ä¸‹è½½æ‰€æœ‰æ‰¹æ¬¡ç»“æœ
      uses: actions/download-artifact@v4
      with:
        pattern: ranking-monitor-batch*-${{ github.run_id }}
        merge-multiple: true
        path: ./batch-results
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd scripts
        npm init -y
        npm install fs-extra moment-timezone
    
    - name: åˆå¹¶æ’åæ•°æ®
      run: |
        echo "ğŸ”— åˆå¹¶æ‰€æœ‰æ‰¹æ¬¡çš„æ’åæ•°æ®"
        cd scripts
        node -e "
        const fs = require('fs-extra');
        const path = require('path');
        
        console.log('å¼€å§‹åˆå¹¶æ’åæ•°æ®...');
        
        const batchDir = '../batch-results';
        if (fs.existsSync(batchDir)) {
          const rankingFiles = fs.readdirSync(batchDir, { recursive: true })
            .filter(file => file.includes('ranking-history.json'));
          
          console.log('æ‰¾åˆ°æ’åæ–‡ä»¶:', rankingFiles.length);
          
          let mergedData = { rankings: {}, history: {} };
          
          rankingFiles.forEach(file => {
            try {
              const filePath = path.join(batchDir, file);
              const data = JSON.parse(fs.readFileSync(filePath, 'utf8'));
              
              if (data.rankings) {
                Object.assign(mergedData.rankings, data.rankings);
              }
              if (data.history) {
                Object.assign(mergedData.history, data.history);
              }
            } catch (error) {
              console.error('åˆå¹¶æ–‡ä»¶å¤±è´¥:', file, error.message);
            }
          });
          
          const outputDir = '../data/rankings';
          fs.ensureDirSync(outputDir);
          
          mergedData.metadata = {
            lastUpdated: new Date().toISOString(),
            totalKeywords: Object.keys(mergedData.rankings).length,
            batchCount: rankingFiles.length
          };
          
          fs.writeFileSync(
            path.join(outputDir, 'ranking-history.json'),
            JSON.stringify(mergedData, null, 2)
          );
          
          console.log('âœ… æ’åæ•°æ®åˆå¹¶å®Œæˆï¼Œå…±', Object.keys(mergedData.rankings).length, 'ä¸ªå…³é”®è¯');
        }
        "
    
    - name: æäº¤åˆå¹¶ç»“æœ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/rankings/ logs/
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„æ’åæ•°æ®"
        else
          git commit -m "ğŸ“Š è‡ªåŠ¨æ’åç›‘æ§åˆå¹¶: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi

  # æ™ºèƒ½åˆ†æä»»åŠ¡
  intelligent-analysis:
    runs-on: ubuntu-latest
    needs: [keyword-collection, merge-ranking-data]
    if: always() && (contains(github.event.schedule, '0 1') || github.event.inputs.task_type == 'analyze' || github.event.inputs.task_type == 'full')
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: æ‹‰å–æœ€æ–°æ•°æ®
      run: |
        git pull origin main || true
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: å®‰è£…ä¾èµ–
      run: |
        cd scripts
        npm init -y
        npm install fs-extra moment-timezone
    
    - name: æ‰§è¡Œæ™ºèƒ½åˆ†æ
      run: |
        echo "ğŸ§  å¼€å§‹æ™ºèƒ½å…³é”®è¯åˆ†æ"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        cd scripts
        node keyword-analyzer.js 2>&1 | tee ../logs/keyword-analysis-$(date +%Y%m%d-%H%M%S).log
    
    - name: ç”Ÿæˆä¼˜åŒ–å»ºè®®æŠ¥å‘Š
      run: |
        echo "ğŸ“‹ ç”Ÿæˆä¼˜åŒ–å»ºè®®æŠ¥å‘Š"
        cd scripts
        node -e "
        const fs = require('fs-extra');
        const moment = require('moment-timezone');
        
        try {
          const analysisFile = '../data/analysis/keyword-analysis.json';
          if (fs.existsSync(analysisFile)) {
            const data = JSON.parse(fs.readFileSync(analysisFile, 'utf8'));
            
            const report = '# å…³é”®è¯æ’åä¼˜åŒ–å»ºè®®æŠ¥å‘Š\\n\\n' +
                          '## æ‰§è¡Œæ‘˜è¦\\n' +
                          '- åˆ†ææ—¶é—´: ' + moment().tz('Asia/Shanghai').format('YYYY-MM-DD HH:mm:ss') + '\\n' +
                          '- åˆ†æå…³é”®è¯: ' + (data.metadata?.totalKeywords || 0) + ' ä¸ª\\n' +
                          '- è¯†åˆ«æœºä¼š: ' + (data.opportunities?.length || 0) + ' ä¸ª\\n\\n' +
                          '## ä¼˜åŒ–å»ºè®®\\n' +
                          '1. ä¼˜å…ˆå¤„ç†é«˜ä»·å€¼å…³é”®è¯çš„æ’åé—®é¢˜\\n' +
                          '2. ä¸ºæ–°æœºä¼šå…³é”®è¯åˆ›å»ºä¸“é—¨å†…å®¹\\n' +
                          '3. æ”¹è¿›æ¥è¿‘çªç ´çš„å…³é”®è¯é¡µé¢\\n' +
                          '4. æŒç»­ç›‘æ§æ’åå˜åŒ–è¶‹åŠ¿\\n\\n' +
                          '---\\n' +
                          '*æ­¤æŠ¥å‘Šç”±24å°æ—¶è‡ªåŠ¨åŒ–ç³»ç»Ÿç”Ÿæˆ*';
        
            fs.writeFileSync('../reports/optimization-suggestions.md', report);
            console.log('âœ… ä¼˜åŒ–å»ºè®®æŠ¥å‘Šå·²ç”Ÿæˆ');
          }
        } catch (error) {
          console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error.message);
        }
        "
    
    - name: æäº¤åˆ†æç»“æœ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/analysis/ reports/ logs/
        if git diff --staged --quiet; then
          echo "æ²¡æœ‰æ–°çš„åˆ†ææ•°æ®"
        else
          git commit -m "ğŸ§  æ™ºèƒ½å…³é”®è¯åˆ†æ: $(date '+%Y-%m-%d %H:%M:%S')"
          git push
        fi
    
    - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: keyword-analysis-report-${{ github.run_id }}
        path: |
          logs/keyword-analysis-*.log
          reports/keyword-analysis-*.json
          reports/optimization-suggestions.md
          data/analysis/
        retention-days: 60

  # ç³»ç»Ÿå¥åº·æ£€æŸ¥
  system-health-check:
    runs-on: ubuntu-latest
    needs: [keyword-collection, merge-ranking-data, intelligent-analysis]
    if: always()
    
    steps:
    - name: æ£€å‡ºä»“åº“
      uses: actions/checkout@v4
    
    - name: æ‹‰å–æœ€æ–°æ•°æ®
      run: |
        git pull origin main || true
    
    - name: æ£€æŸ¥ç³»ç»Ÿå¥åº·çŠ¶æ€
      run: |
        echo "ğŸ¥ æ‰§è¡Œå…³é”®è¯æ’åç³»ç»Ÿå¥åº·æ£€æŸ¥"
        echo "æ£€æŸ¥æ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        
        if [ -f "data/keywords/keywords-database.json" ]; then
          KEYWORD_COUNT=$(cat data/keywords/keywords-database.json | grep -o '"[^"]*":' | wc -l)
          echo "âœ… å…³é”®è¯æ•°æ®åº“: $KEYWORD_COUNT ä¸ªå…³é”®è¯"
        else
          echo "âŒ å…³é”®è¯æ•°æ®åº“æ–‡ä»¶ç¼ºå¤±"
        fi
        
        if [ -f "data/rankings/ranking-history.json" ]; then
          echo "âœ… æ’åå†å²æ•°æ®: æ­£å¸¸"
        else
          echo "âŒ æ’åå†å²æ•°æ®æ–‡ä»¶ç¼ºå¤±"
        fi
        
        if [ -f "data/analysis/keyword-analysis.json" ]; then
          echo "âœ… åˆ†ææ•°æ®: æ­£å¸¸"
        else
          echo "âŒ åˆ†ææ•°æ®æ–‡ä»¶ç¼ºå¤±"
        fi
        
        LOG_COUNT=$(find logs/ -name "*.log" -mtime -1 2>/dev/null | wc -l)
        echo "ğŸ“‹ æœ€è¿‘24å°æ—¶æ—¥å¿—: $LOG_COUNT ä¸ªæ–‡ä»¶"
        
        REPORT_COUNT=$(find reports/ -name "*.json" -mtime -7 2>/dev/null | wc -l)
        echo "ğŸ“Š æœ€è¿‘7å¤©æŠ¥å‘Š: $REPORT_COUNT ä¸ªæ–‡ä»¶"
    
    - name: ç”Ÿæˆç³»ç»ŸçŠ¶æ€æŠ¥å‘Š
      run: |
        cat > system-status-$(date +%Y%m%d).md << 'EOF'
        # å…³é”®è¯æ’åç³»ç»ŸçŠ¶æ€æŠ¥å‘Š
        
        **ç”Ÿæˆæ—¶é—´**: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')
        **å·¥ä½œæµID**: ${{ github.run_id }}
        
        ## ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€
        - **å…³é”®è¯é‡‡é›†**: ${{ needs.keyword-collection.result }}
        - **æ’åç›‘æ§**: ${{ needs.ranking-monitor.result }}
        - **æ•°æ®åˆå¹¶**: ${{ needs.merge-ranking-data.result }}
        - **æ™ºèƒ½åˆ†æ**: ${{ needs.intelligent-analysis.result }}
        
        ## ç³»ç»ŸæŒ‡æ ‡
        - **ç›‘æ§é¢‘ç‡**: æ¯4å°æ—¶æ’åæ£€æŸ¥ï¼Œæ¯æ—¥2æ¬¡å…³é”®è¯é‡‡é›†
        - **æ•°æ®å®Œæ•´æ€§**: è‡ªåŠ¨æ£€æŸ¥å’Œä¿®å¤
        - **æŠ¥å‘Šç”Ÿæˆ**: è‡ªåŠ¨ç”Ÿæˆåˆ†ææŠ¥å‘Šå’Œä¼˜åŒ–å»ºè®®
        
        ## ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
        - **å…³é”®è¯é‡‡é›†**: æ¯æ—¥ 10:00 å’Œ 22:00 (åŒ—äº¬æ—¶é—´)
        - **æ’åç›‘æ§**: æ¯4å°æ—¶æ‰§è¡Œä¸€æ¬¡
        - **æ™ºèƒ½åˆ†æ**: æ¯æ—¥ 09:00 (åŒ—äº¬æ—¶é—´)
        
        ---
        *ç³»ç»Ÿæ­£åœ¨24å°æ—¶è‡ªåŠ¨è¿è¡Œä¸­*
        EOF
        
        git add system-status-*.md
        git commit -m "ğŸ“Š ç³»ç»ŸçŠ¶æ€æŠ¥å‘Š: $(date '+%Y-%m-%d %H:%M:%S')" || true
        git push || true

  # é€šçŸ¥å’Œè­¦æŠ¥
  notification:
    runs-on: ubuntu-latest
    needs: [keyword-collection, merge-ranking-data, intelligent-analysis, system-health-check]
    if: always()
    
    steps:
    - name: åˆ†ææ‰§è¡Œç»“æœ
      run: |
        echo "ğŸ“Š åˆ†ææ‰€æœ‰ä»»åŠ¡æ‰§è¡Œç»“æœ"
        
        COLLECTION_STATUS="${{ needs.keyword-collection.result }}"
        MONITOR_STATUS="${{ needs.merge-ranking-data.result }}"
        ANALYSIS_STATUS="${{ needs.intelligent-analysis.result }}"
        HEALTH_STATUS="${{ needs.system-health-check.result }}"
        
        echo "å…³é”®è¯é‡‡é›†: $COLLECTION_STATUS"
        echo "æ’åç›‘æ§: $MONITOR_STATUS"
        echo "æ™ºèƒ½åˆ†æ: $ANALYSIS_STATUS"
        echo "å¥åº·æ£€æŸ¥: $HEALTH_STATUS"
        
        if [[ "$COLLECTION_STATUS" == "failure" || "$MONITOR_STATUS" == "failure" || "$ANALYSIS_STATUS" == "failure" ]]; then
          echo "âš ï¸ æ£€æµ‹åˆ°ä»»åŠ¡å¤±è´¥ï¼Œéœ€è¦å…³æ³¨"
          echo "ALERT_NEEDED=true" >> $GITHUB_ENV
        else
          echo "âœ… æ‰€æœ‰ä»»åŠ¡æ‰§è¡Œæ­£å¸¸"
          echo "ALERT_NEEDED=false" >> $GITHUB_ENV
        fi
    
    - name: å‘é€æˆåŠŸé€šçŸ¥
      if: env.ALERT_NEEDED == 'false'
      run: |
        echo "âœ… 24å°æ—¶å…³é”®è¯æ’åç›‘æ§ç³»ç»Ÿæ‰§è¡ŒæˆåŠŸ"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "æ‰€æœ‰ä»»åŠ¡å‡æ­£å¸¸å®Œæˆï¼Œç³»ç»ŸæŒç»­è¿è¡Œä¸­"
    
    - name: å‘é€è­¦æŠ¥é€šçŸ¥
      if: env.ALERT_NEEDED == 'true'
      run: |
        echo "ğŸš¨ å…³é”®è¯æ’åç›‘æ§ç³»ç»Ÿæ£€æµ‹åˆ°å¼‚å¸¸"
        echo "æ‰§è¡Œæ—¶é—´: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
        echo "è¯·æ£€æŸ¥å¤±è´¥çš„ä»»åŠ¡å¹¶åŠæ—¶å¤„ç†"
        
    - name: æ¸…ç†æ—§æ•°æ®
      run: |
        echo "ğŸ§¹ æ¸…ç†è¶…è¿‡30å¤©çš„æ—§æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶"
        
        find logs/ -name "*.log" -mtime +30 -delete 2>/dev/null || true
        find reports/ -name "*.json" -mtime +60 -delete 2>/dev/null || true
        find . -name "*.tmp" -delete 2>/dev/null || true
        
        echo "âœ… æ¸…ç†å®Œæˆ" 